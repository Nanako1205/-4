<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>住所→緯度経度 変換ツール（Nominatim）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 24px; line-height: 1.6; }
    button { padding: 8px 14px; font-size: 14px; cursor: pointer; }
    #log { margin-top: 12px; padding: 10px; border: 1px solid #ccc; max-height: 55vh; overflow: auto; white-space: pre-wrap; }
    code, kbd { background: rgba(125,125,125,.12); padding: 0 .25em; border-radius: 4px; }
    .small { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <h1>住所→緯度経度 変換ツール（Nominatim）</h1>
  <p>
    使い方：<br>
    ① <code>/data/spots.json</code> を用意する → ② 下の <strong>変換開始</strong> を1回だけ押す → ③
    <code>spots_geocoded.json</code> がダウンロードされるので <code>/data/</code> にアップロード。
  </p>
  <p class="small">
    ※ 公開APIは <strong>1秒に1件</strong> のリクエスト制限があります。本ツールは自動的に1.1秒待機します。<br>
    ※ 結果はローカル（/data/spots_geocoded.json）に保存・再利用してください（繰り返しの大量実行は避ける）。
  </p>

  <button id="start">変換開始</button>
  <div id="log" aria-live="polite"></div>

  <script>
    // ログ出力
    const logEl = document.getElementById('log');
    const log = (m) => { const p = document.createElement('div'); p.textContent = m; logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight; };

    // ---- Nominatim で1件ジオコーディング（1件ずつ呼ぶ）----
    async function geocodeOne(q) {
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', q);
      url.searchParams.set('format', 'json');
      url.searchParams.set('addressdetails', '0');
      url.searchParams.set('limit', '1');
      const res = await fetch(url.toString(), { method: 'GET' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const arr = await res.json();
      if (!Array.isArray(arr) || arr.length === 0) return null;
      return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon) };
    }

    // ---- spots.json をロード（絶対URL・キャッシュ無効化で確実に）----
    async function loadSpotsJson() {
      const url = 'https://nanako1205.github.io/-4/data/spots.json?ts=' + Date.now();
      log('spots.json を読み込み中… (' + url + ')');
      const res = await fetch(url, { cache: 'no-store' });
      log('  → STATUS: ' + res.status);
      if (!res.ok) throw new Error('spots.json 読み込み失敗: HTTP ' + res.status);
      return res.json();
    }

    // ---- メイン処理 ----
    async function start() {
      try {
        const spots = await loadSpotsJson();
        if (!Array.isArray(spots) || spots.length === 0) {
          log('spots.json にデータがありません。'); return;
        }
        log('spots 件数: ' + spots.length);

        const out = [];
        for (let i = 0; i < spots.length; i++) {
          const s = spots[i];
          const q = String(s.address || '').trim();
          log(`[${i+1}/${spots.length}] ${s.name || '(名称未設定)'} : ${q || '(住所なし)'}`);

          try {
            if (!q) throw new Error('空の住所');
            const pos = await geocodeOne(q);
            if (pos) {
              out.push({ ...s, lat: pos.lat, lng: pos.lng, src: 'nominatim' });
              log(`  → OK ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`);
            } else {
              out.push({ ...s, lat: null, lng: null, src: 'nominatim', note: 'not_found' });
              log('  → 見つからず（住所表記を見直してください）');
            }
          } catch (e) {
            out.push({ ...s, lat: null, lng: null, src: 'nominatim', note: 'error:' + e.message });
            log('  → エラー: ' + e.message);
          }

          // 公開APIは 1 req/sec → 保険で 1.1 秒待機
          await new Promise(r => setTimeout(r, 1100));
        }

        // ---- ダウンロード ----
        const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'spots_geocoded.json';
        a.click();
        URL.revokeObjectURL(a.href);
        log('完了：spots_geocoded.json を保存しました。/data にアップロードしてください。');

      } catch (e) {
        log('致命的エラー: ' + (e && e.message ? e.message : e));
      }
    }

    document.getElementById('start').addEventListener('click', start);
  </script>
</body>
</html>
