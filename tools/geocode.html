
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>住所→緯度経度 変換ツール（Nominatim）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    button { padding: 8px 14px; }
    pre { background: #f5f5f5; padding: 12px; white-space: pre-wrap; }
    .log { max-height: 40vh; overflow: auto; border: 1px solid #ddd; padding: 8px; }
  </style>
</head>
<body>
  <h1>住所→緯度経度 変換ツール（Nominatim）</h1>
  <p>以下のボタンを押すと <code>./data/spots.json</code> を読み込み、1件ずつ Nominatim で緯度経度に変換して <code>spots_geocoded.json</code> をダウンロードします。</p>
  <p><strong>注意：</strong> 公開APIは <mark>1秒に1リクエスト</mark> の制限があります。このツールは自動的に間隔を空けます。大量処理・自動連打は行わないでください。利用ポリシーに従って、結果はローカルに保存・キャッシュして再利用してください。[1](https://github.com/Nanako1205/)</p>

  <button id="start">変換開始</button>
  <div class="log" id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const log = (m) => { const p = document.createElement('div'); p.textContent = m; logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight; };

    async function geocodeOne(q) {
      // Nominatim へのクエリ（公開API）
      // 参考: 利用ポリシー（1 req/sec, 識別可能なUA/Referer等）[1](https://github.com/Nanako1205/)
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', q);
      url.searchParams.set('format', 'json');
      url.searchParams.set('addressdetails', '0');
      url.searchParams.set('limit', '1');
      // ブラウザからは UA を任意設定できないため、Referer が送出されます（人手操作の1回実行・小規模に限定）

      const res = await fetch(url.toString(), {
        headers: {
          // 明示 attribution 用に 'Accept-Language' を指定してもOK（任意）
        }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const arr = await res.json();
      if (!Array.isArray(arr) || arr.length === 0) return null;
      const hit = arr[0];
      return { lat: parseFloat(hit.lat), lng: parseFloat(hit.lon) };
    }

    async function start() {
      log('spots.json を読み込み中…');
      const base = window.location.origin + window.location.pathname.replace(/\/tools\/.*$/, '/');
      const res = await fetch(base + 'data/spots.json', { cache: 'no-cache' });
      if (!res.ok) { log(`spots.json 読み込み失敗: HTTP ${res.status}`); return; }
      const spots = await res.json();

      const out = [];
      for (let i = 0; i < spots.length; i++) {
        const s = spots[i];
        const q = `${s.address}`;
        log(`[${i+1}/${spots.length}] ${s.name} をジオコーディング…`);
        try {
          const pos = await geocodeOne(q);
          if (pos) {
            out.push({ ...s, lat: pos.lat, lng: pos.lng, src: 'nominatim' });
            log(`  → OK (${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)})`);
          } else {
            out.push({ ...s, lat: null, lng: null, src: 'nominatim', note: 'not_found' });
            log('  → 見つからず（手動確認が必要）');
          }
        } catch (e) {
          out.push({ ...s, lat: null, lng: null, src: 'nominatim', note: `error: ${e.message}` });
          log('  → エラー: ' + e.message);
        }
        // Nominatim 公開APIは 1 リクエスト/秒の上限 → 1.1秒待機（保険）
        // 利用ポリシーの尊重のためバーストしません。[1](https://github.com/Nanako1205/)
        await new Promise(r => setTimeout(r, 1100));
      }

      // ダウンロード
      const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'spots_geocoded.json';
      a.click();
      URL.revokeObjectURL(a.href);
      log('完了！ spots_geocoded.json を保存しました。/data に置き換えてください。');
    }

    document.getElementById('start').addEventListener('click', start);
  </script>
</body>
</html>
